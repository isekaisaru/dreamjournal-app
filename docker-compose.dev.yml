# ========================================
# ğŸ› ï¸ å¤¢ãƒ­ã‚° é–‹ç™ºç’°å¢ƒç‰¹åŒ–è¨­å®š
# ========================================
# 
# ä½¿ç”¨æ–¹æ³•:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
# 
# é–‹ç™ºç’°å¢ƒã§ã®æœ€é©åŒ–:
# - ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œ
# - è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
# - é–‹ç™ºç”¨ãƒ„ãƒ¼ãƒ«ã®æœ‰åŠ¹åŒ–
# - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

services:
  # =========================
  # ğŸ—„ï¸ PostgreSQL é–‹ç™ºè¨­å®š
  # =========================
  db:
    # é–‹ç™ºç”¨ãƒ­ã‚°è¨­å®š
    command: >
      postgres
      -c log_statement=all
      -c log_duration=on
      -c log_min_duration_statement=0
      -c shared_preload_libraries=pg_stat_statements
    # é–‹ç™ºç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é »åº¦ã‚’é«˜ã
    healthcheck:
      interval: 3s
      timeout: 3s
      retries: 3
      start_period: 5s

  # =========================
  # âš¡ Rails API é–‹ç™ºè¨­å®š
  # =========================
  backend:
    build:
      args:
        RAILS_ENV: development
    # ğŸ“ é–‹ç™ºç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ è¨­å®š
    volumes:
      - ./backend:/app:cached                    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰åŒæœŸï¼ˆæœ€é«˜å„ªå…ˆåº¦ï¼‰
      - backend_gems_dev:/usr/local/bundle       # Gemæ°¸ç¶šåŒ–ï¼ˆé«˜é€ŸåŒ–ï¼‰
      - backend_tmp_dev:/app/tmp                 # ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«é«˜é€ŸåŒ–
      - backend_log_dev:/app/log                 # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æ°¸ç¶šåŒ–
      - backend_node_modules:/app/node_modules   # Node.jsä¾å­˜é–¢ä¿‚ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
    
    # ğŸ”§ é–‹ç™ºç’°å¢ƒå¤‰æ•°
    environment:
      - RAILS_ENV=development
      - RAILS_LOG_LEVEL=debug                    # è©³ç´°ãƒ­ã‚°
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=false           # é–‹ç™ºã§ã¯ç„¡åŠ¹
      - RAILS_MAX_THREADS=1                      # ãƒ‡ãƒãƒƒã‚°æ™‚ã®ä¸¦è¡Œæ€§ã‚’åˆ¶é™
      - BUNDLE_PATH=/usr/local/bundle
      
      # ğŸ” ãƒ‡ãƒãƒƒã‚°è¨­å®š
      - RUBY_DEBUG_OPEN=true                     # ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒãƒƒã‚°å¯¾å¿œ
      - RUBY_DEBUG_HOST=0.0.0.0
      - RUBY_DEBUG_PORT=12345
      
      # ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
      - NEW_RELIC_AGENT_ENABLED=false            # é–‹ç™ºã§ã¯ç„¡åŠ¹
      - SKYLIGHT_AUTHENTICATION=disabled         # é–‹ç™ºã§ã¯ç„¡åŠ¹

    # ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒãƒ¼ãƒˆå…¬é–‹
    ports:
      - "3001:3001"    # Rails API
      - "12345:12345"  # Ruby Debug Protocol

    # ğŸƒ é–‹ç™ºç”¨èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
    command: >
      rails server -p 3001 -b 0.0.0.0
    
    # ğŸ©º é–‹ç™ºç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # =========================
  # ğŸ¨ Next.js é–‹ç™ºè¨­å®š
  # =========================
  frontend:
    # ğŸ“ é–‹ç™ºç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ è¨­å®š
    volumes:
      - ./frontend:/app:cached                   # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰åŒæœŸï¼ˆæœ€é«˜å„ªå…ˆåº¦ï¼‰
      - frontend_node_modules_dev:/app/node_modules  # node_modulesæ°¸ç¶šåŒ–
      - frontend_next_cache_dev:/app/.next       # Next.jsã‚­ãƒ£ãƒƒã‚·ãƒ¥æ°¸ç¶šåŒ–
    
    # ğŸ”§ é–‹ç™ºç’°å¢ƒå¤‰æ•°
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:3001
      - INTERNAL_API_URL=http://backend:3001
      
      # ğŸ”¥ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ€é©åŒ–
      - WATCHPACK_POLLING=true                   # ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ï¼ˆMac/Winï¼‰
      - CHOKIDAR_USEPOLLING=true                 # å¤‰æ›´æ¤œçŸ¥å®‰å®šåŒ–
      - FAST_REFRESH=true                        # React Fast Refresh
      
      # ğŸš€ é–‹ç™ºç”¨æœ€é©åŒ–
      - NEXT_TELEMETRY_DISABLED=1                # ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªç„¡åŠ¹
      - DISABLE_ESLINT_PLUGIN=false              # ESLintãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ‰åŠ¹

    # ğŸƒ é–‹ç™ºç”¨èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
    command: >
      sh -c "
        echo 'ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒèµ·å‹•ä¸­...' &&
        yarn install &&
        echo 'ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†' &&
        echo 'ğŸ”¥ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ã§èµ·å‹•ä¸­...' &&
        yarn dev
      "

# =========================
# ğŸ“ é–‹ç™ºç”¨Named Volumes
# =========================
volumes:
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç”¨
  backend_gems_dev:
    name: dream_journal_dev_gems
  backend_tmp_dev:
    name: dream_journal_dev_tmp
  backend_log_dev:
    name: dream_journal_dev_log
  backend_node_modules:
    name: dream_journal_dev_backend_node_modules
  
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç”¨
  frontend_node_modules_dev:
    name: dream_journal_dev_frontend_node_modules
  frontend_next_cache_dev:
    name: dream_journal_dev_next_cache

# =========================
# ğŸŒ é–‹ç™ºç”¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
# =========================
networks:
  default:
    name: dream_journal_dev_network
    driver: bridge