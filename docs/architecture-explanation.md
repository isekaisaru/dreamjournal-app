# DreamJournal アーキテクチャ説明メモ

## 📋 目的

このドキュメントは、DreamJournalアプリケーションのアーキテクチャについて、**面接で3分で説明できる**ようにまとめたものです。

---

## 🎯 システム全体のアーキテクチャ

### **概要**

DreamJournalは、**Next.js 15（フロントエンド）** + **Rails 8 API（バックエンド）** + **Supabase（データベース・認証）** で構成されたフルスタックアプリケーションです。

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   フロントエンド                             │
│                   Next.js 15 (App Router)                   │
│                   Vercel でデプロイ                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   バックエンド                               │
│                   Rails 8 API mode                          │
│                   Render でデプロイ                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   データベース・認証                         │
│                   Supabase (PostgreSQL + Auth)              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 技術選定の理由

### **1. なぜNext.js 15を選んだか？**

#### **選定理由**

1. **App Routerによるモダンな開発体験**
   - Server ComponentsとClient Componentsの使い分けにより、パフォーマンスとUXを両立
   - ファイルベースルーティングにより、直感的なページ構成

2. **SEO対策**
   - Server-Side Rendering（SSR）により、検索エンジンに優しい
   - メタタグの動的生成により、SNSシェア時のプレビューも最適化

3. **開発効率**
   - TypeScriptによる型安全性
   - Hot Reloadによる高速な開発サイクル

4. **デプロイの簡単さ**
   - Vercelとの親和性が高く、デプロイが簡単
   - 自動的にプレビュー環境が作成される

#### **実際の使用例**

- **Server Components**: 夢の一覧表示（`app/dreams/page.tsx`）
- **Client Components**: 夢の作成フォーム（`app/dreams/new/page.tsx`）
- **動的ルーティング**: 夢の詳細表示（`app/dreams/[id]/page.tsx`）

---

### **2. なぜAPI分離（Rails 8）を選んだか？**

#### **選定理由**

1. **フロントエンドとバックエンドの分離**
   - フロントエンドとバックエンドを独立して開発・デプロイできる
   - 技術スタックの変更が容易（例：Next.jsをReactに変更しても、バックエンドは変更不要）

2. **スケーラビリティ**
   - フロントエンドとバックエンドを別々にスケールできる
   - 負荷分散が容易

3. **RESTful APIの設計**
   - リソースベースのルーティングにより、APIの設計が直感的
   - HTTPメソッド（GET、POST、PUT、DELETE）により、操作が明確

4. **Rails 8の新機能**
   - Kamalによる簡単なデプロイ
   - Solid Cacheによる高速なキャッシュ

#### **実際の使用例**

- **夢の一覧取得**: `GET /dreams`
- **夢の作成**: `POST /dreams`
- **夢の分析**: `POST /dreams/:id/analyze`

---

### **3. なぜSupabaseを選んだか？**

#### **選定理由**

1. **PostgreSQLベースのデータベース**
   - リレーショナルデータベースとして、データの整合性を保証
   - SQLによる柔軟なクエリ

2. **Supabase Authによる認証**
   - JWTトークンによる認証
   - メールアドレス・パスワードによるログイン
   - セッション管理

3. **コスト効率**
   - 無料プランで500MB、50,000リクエスト/月
   - 有料プランでも$25/月から

4. **Row Level Security（RLS）**
   - データベースレベルでのセキュリティ
   - ユーザーごとにデータを分離

#### **実際の使用例**

- **ユーザー認証**: Supabase Authによるログイン・ログアウト
- **夢データの保存**: PostgreSQLによるデータ保存
- **RLSポリシー**: ユーザーごとに夢データを分離（将来的に実装予定）

---

### **4. なぜSentryを選んだか？**

#### **選定理由**

1. **エラー監視**
   - 本番環境でのエラーをリアルタイムで検知
   - エラーの詳細情報（スタックトレース、ユーザー情報）を取得

2. **パフォーマンス監視**
   - ページの読み込み時間を監視
   - APIのレスポンス時間を監視

3. **本番運用の安定性**
   - エラーが発生した際に、すぐに対応できる
   - ユーザーに影響が出る前に問題を検知

4. **無料プランの充実**
   - 5,000イベント/月まで無料

#### **実際の使用例**

- **フロントエンドのエラー監視**: Next.jsでのエラーを検知
- **バックエンドのエラー監視**: Railsでのエラーを検知
- **パフォーマンス監視**: ページの読み込み時間を監視

---

## 🔐 認証フロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. ユーザーがログインフォームにメールアドレス・パスワードを入力  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. フロントエンド（Next.js）がバックエンド（Rails）に           │
│     POST /auth/login リクエストを送信                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. バックエンド（Rails）がSupabase Authに認証リクエストを送信   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Supabase AuthがJWTトークンを返す                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  5. バックエンド（Rails）がJWTトークンをフロントエンドに返す      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  6. フロントエンド（Next.js）がJWTトークンをCookieに保存         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  7. 以降のリクエストでJWTトークンをAuthorizationヘッダーに含める  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 デプロイフロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. GitHubにコードをプッシュ                                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. GitHub Actionsが自動的にテストを実行                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. テストが成功したら、Vercel（フロントエンド）と              │
│     Render（バックエンド）に自動デプロイ                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. デプロイが完了したら、本番環境で動作確認                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 運用実績

- **本番運用期間**: 30日間
- **重大障害**: 0件
- **エラー監視**: Sentryによるリアルタイム監視
- **パフォーマンス**: ページ読み込み時間 < 2秒

---

## 🎯 今後の改善点

1. **RLSポリシーの実装**
   - ユーザーごとに夢データを分離
   - データベースレベルでのセキュリティ強化

2. **パフォーマンス最適化**
   - 画像の最適化（Next.js Image）
   - キャッシュ戦略の改善

3. **テストカバレッジの向上**
   - フロントエンドのテストカバレッジ: 80%以上
   - バックエンドのテストカバレッジ: 90%以上

---

## 💡 面接での説明例（3分バージョン）

> 「DreamJournalは、Next.js 15とRails 8 APIで構成されたフルスタックアプリケーションです。」
> 
> 「フロントエンドにNext.js 15を選んだ理由は、App Routerによるモダンな開発体験と、SEO対策です。Server ComponentsとClient Componentsを使い分けることで、パフォーマンスとUXを両立しています。」
> 
> 「バックエンドにRails 8 APIを選んだ理由は、フロントエンドとバックエンドを分離することで、スケーラビリティと技術スタックの柔軟性を確保するためです。RESTful APIの設計により、APIの設計が直感的になっています。」
> 
> 「データベースと認証にSupabaseを選んだ理由は、PostgreSQLベースのデータベースと、Supabase Authによる認証が簡単に実装できるためです。コスト効率も良く、無料プランで500MB、50,000リクエスト/月まで使えます。」
> 
> 「エラー監視にSentryを選んだ理由は、本番環境でのエラーをリアルタイムで検知し、すぐに対応できるためです。現在、本番運用30日間で重大障害0件を達成しています。」
> 
> 「このアーキテクチャにより、安定した運用と、今後のスケーラビリティを確保しています。」

---

## 📚 参考資料

- [Next.js 15 Documentation](https://nextjs.org/docs)
- [Rails 8 API Documentation](https://guides.rubyonrails.org/api_app.html)
- [Supabase Documentation](https://supabase.com/docs)
- [Sentry Documentation](https://docs.sentry.io/)
