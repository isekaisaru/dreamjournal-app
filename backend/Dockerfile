# syntax=docker/dockerfile:1

# ========================================
# ğŸš€ å¤¢ãƒ­ã‚° ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ€é©åŒ–Dockerfile v3
# ========================================
# 
# æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ:
# 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ€å¤§æ´»ç”¨ã™ã‚‹é †åº
# 2. ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸è»½é‡åŒ–
# 3. é–‹ç™º/æœ¬ç•ªç’°å¢ƒã®é©åˆ‡ãªåˆ‡ã‚Šåˆ†ã‘
# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆnon-rootãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

ARG RUBY_VERSION=3.3.0
ARG RAILS_ENV=production

# ========================================
# ğŸ“¦ Base Stage: å…±é€šåŸºç›¤
# ========================================
FROM ruby:${RUBY_VERSION}-bullseye AS base

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV RAILS_ENV=${RAILS_ENV} \
    BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3

# åŸºæœ¬çš„ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# apt-get clean ã¨ rm ã‚’åŒã˜RUNãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®Ÿè¡Œã—ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ–
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
      libvips \
      postgresql-client \
      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨
      curl \
      # Whisperã§ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ç”¨
      ffmpeg \
      # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿
      tzdata \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
# Copy application code
WORKDIR /app

# ========================================
# ğŸ”¨ Builder Stage: ãƒ“ãƒ«ãƒ‰å°‚ç”¨
# ========================================
FROM base AS builder

# ãƒ“ãƒ«ãƒ‰æ™‚ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
      # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ„ãƒ¼ãƒ«
      build-essential \
      # PostgreSQLé–‹ç™ºãƒ©ã‚¤ãƒ–ãƒ©ãƒª
      libpq-dev \
      # Gitï¼ˆGemfileå†…ã®gitå‚ç…§å¯¾å¿œï¼‰
      git \
    && rm -rf /var/lib/apt/lists/*

# ğŸ¯ æœ€é‡è¦æœ€é©åŒ–: Gemfileé–¢é€£ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼
# ã“ã‚Œã«ã‚ˆã‚ŠGemfileãŒå¤‰æ›´ã•ã‚Œãªã„é™ã‚Šbundle installã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
COPY Gemfile Gemfile.lock ./

# ç’°å¢ƒã«å¿œã˜ãŸGemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé–‹ç™ºç”¨gemã‚‚å«ã‚€ or æœ¬ç•ªã®ã¿ï¼‰
RUN echo "ğŸš€ Railsç’°å¢ƒ: $RAILS_ENV ã§Gemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹" && \
    if [ "$RAILS_ENV" = "production" ]; then \
      echo "ğŸ“¦ æœ¬ç•ªç”¨Gemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..." && \
      bundle config set --local without 'development test' && \
      bundle install --jobs $BUNDLE_JOBS --retry $BUNDLE_RETRY; \
    else \
      echo "ğŸ“¦ é–‹ç™ºç”¨Gemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ï¼ˆå…¨ç’°å¢ƒï¼‰..." && \
      bundle install --jobs $BUNDLE_JOBS --retry $BUNDLE_RETRY; \
    fi && \
    echo "âœ… Gemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†" && \
    bundle clean --force

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆGemã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œï¼‰
COPY . .

# æœ¬ç•ªç’°å¢ƒã§ã®ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
RUN if [ "$RAILS_ENV" = "production" ]; then \
      echo "ğŸ¨ ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å®Ÿè¡Œä¸­..." && \
      bundle exec rails assets:precompile && \
      echo "âœ… ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å®Œäº†"; \
    fi

# ========================================
# ğŸƒ Final Stage: å®Ÿè¡Œç’°å¢ƒ
# ========================================
FROM base AS final

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: non-rootãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN groupadd -r rails && \
    useradd --no-log-init -r -g rails rails && \
    mkdir -p /app/tmp /app/log && \
    chown -R rails:rails /app

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=rails:rails /usr/local/bundle/ /usr/local/bundle/
COPY --from=builder --chown=rails:rails /app /app

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™
COPY --chown=rails:rails entrypoint.sh /usr/bin/entrypoint.sh
RUN chmod +x /usr/bin/entrypoint.sh && \
    # Windowsç’°å¢ƒã§ã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰å¯¾å¿œ
    sed -i 's/\r$//' /usr/bin/entrypoint.sh

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: railsãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER rails:rails

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 3001

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3001/health || exit 1

# èµ·å‹•è¨­å®š
ENTRYPOINT ["/usr/bin/entrypoint.sh"]
CMD ["bundle", "exec", "rails", "server", "-p", "3001", "-b", "0.0.0.0"]

# ========================================
# ğŸ“Š ãƒ“ãƒ«ãƒ‰æƒ…å ±
# ========================================
LABEL \
  org.opencontainers.image.title="Dream Journal Backend" \
  org.opencontainers.image.description="Rails API for Dream Journal Application" \
  org.opencontainers.image.version="3.0" \
  org.opencontainers.image.source="https://github.com/your-org/dream-journal" \
  maintainer="Dream Journal Team"