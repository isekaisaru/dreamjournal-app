# ========================================
# ğŸš€ å¤¢ãƒ­ã‚° æœ¬ç•ªç’°å¢ƒè¨­å®š
# ========================================
# 
# ä½¿ç”¨æ–¹æ³•:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# 
# æœ¬ç•ªç’°å¢ƒã§ã®æœ€é©åŒ–:
# - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
# - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
# - ãƒ­ã‚°é›†ç´„ãƒ»ç›£è¦–å¯¾å¿œ
# - é«˜å¯ç”¨æ€§è¨­å®š

services:
  # =========================
  # ğŸ—„ï¸ PostgreSQL æœ¬ç•ªè¨­å®š
  # =========================
  db:
    # æœ¬ç•ªç”¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    
    environment:
      # æœ¬ç•ªç”¨è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ³¨å…¥ï¼‰
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    
    # ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
    networks:
      - backend_network  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ç›´æ¥æ¥ç¶šã‚’ç¦æ­¢
    
    # ğŸ“Š æœ¬ç•ªç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    # ğŸš€ ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # =========================
  # âš¡ Rails API æœ¬ç•ªè¨­å®š
  # =========================
  backend:
    build:
      args:
        RAILS_ENV: production
    
    # ğŸ”’ æœ¬ç•ªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
    read_only: true                              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ èª­ã¿å–ã‚Šå°‚ç”¨
    tmpfs:
      - /tmp                                     # ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ç”¨
      - /app/tmp                                 # Railsç”¨ãƒ†ãƒ³ãƒãƒ©ãƒª
    
    # ğŸ”§ æœ¬ç•ªç’°å¢ƒå¤‰æ•°
    environment:
      - RAILS_ENV=production
      - RAILS_LOG_LEVEL=info                     # æœ¬ç•ªç”¨ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true            # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡
      - RAILS_MAX_THREADS=5                      # æœ¬ç•ªç”¨ä¸¦è¡Œæ€§
      - WEB_CONCURRENCY=2                        # Pumaãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
      
      # ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
      - RAILS_FORCE_SSL=true                     # HTTPSå¼·åˆ¶
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
      
      # ğŸ“Š å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_EXPIRATION_TIME=${JWT_EXPIRATION_TIME:-3600}

    # ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢
    networks:
      - frontend_network
      - backend_network
    
    # ğŸ©º æœ¬ç•ªç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # ğŸš€ ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒ»è‡ªå‹•å†èµ·å‹•
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # ğŸ“Š ãƒ­ã‚°è¨­å®š
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================
  # ğŸ¨ Next.js æœ¬ç•ªè¨­å®š
  # =========================
  frontend:
    build:
      args:
        NODE_ENV: production
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    
    # ğŸ”§ æœ¬ç•ªç’°å¢ƒå¤‰æ•°
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - INTERNAL_API_URL=http://backend:3001
      
      # ğŸš€ æœ¬ç•ªæœ€é©åŒ–
      - NEXT_TELEMETRY_DISABLED=1
    
    # ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
    networks:
      - frontend_network
    
    # ğŸš€ ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # ğŸ“Š ãƒ­ã‚°è¨­å®š
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =========================
# ğŸ“ æœ¬ç•ªç”¨Named Volumes
# =========================
volumes:
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ°¸ç¶šåŒ–ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾å¿œï¼‰
  pg_data_prod:
    name: dream_journal_prod_db
    driver: local
    driver_opts:
      type: none
      device: /opt/dream-journal/data/postgres
      o: bind

# =========================
# ğŸŒ æœ¬ç•ªç”¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢
# =========================
networks:
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ï¼ˆå¤–éƒ¨å…¬é–‹ï¼‰
  frontend_network:
    name: dream_journal_frontend
    driver: bridge
    
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ï¼ˆå†…éƒ¨å°‚ç”¨ï¼‰
  backend_network:
    name: dream_journal_backend
    driver: bridge
    internal: true  # å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢